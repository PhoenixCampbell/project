<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Faculty-Class Match - Admin</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--Bootstrap CSS-->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<!--custom CSS-->
		<link href="css/styles.css" rel="stylesheet" />
	</head>
	<body>
		<header>
			<!--shared nav across pages for stylied cohesion-->
			<!--orginally taken from index.html-->
			<nav
				class="navbar navbar-expand-lg bg-body-tertiary border-bottom sticky-top"
			>
				<div class="container">
					<a class="navbar-brand fw-bold text-primary" href="#"
						>DSU Faculty–Class Match</a
					>
					<button
						class="navbar-toggler"
						type="button"
						data-bs-toggle="collapse"
						data-bs-target="#navbarNav"
					>
						<span class="navbar-toggler-icon"></span>
					</button>
					<div id="navbarNav" class="collapse navbar-collapse">
						<ul class="navbar-nav ms-auto">
							<li class="nav-item">
								<a class="nav-link" href="faculty.html"
									>Faculty Preferences</a
								>
							</li>
							<li class="nav-item">
								<a
									class="nav-link active"
									aria-current="page"
									href="admin.html"
									>Admin</a
								>
							</li>
						</ul>
					</div>
				</div>
			</nav>
		</header>

		<main class="container my-4">
			<h1 clas="h3 mb-3">Admin: Run Solver</h1>
			<p class="text-muted mb-4">
				This will run the assignment solver on the collected faculty
				preferences and generate the excel results file.
			</p>

			<div class="card">
				<div class="card-body">
					<h2 class="h5">Solver Control</h2>
					<p class="small text-muted mb-3">
						when the button is clicked below, the server will run
						the Python solver script and write the solution Excel
						file -> <code>solver.py</code> and write the solution
						excel file.
					</p>

					<button id="runSolverBtn" class="btn btn-primary">
						Run Solver
					</button>

					<div id="solverStatus" class="mt-3 small"></div>
				</div>
			</div>
		</main>
		<main class="container my-4">
			<h4>Download Instructor Preferences</h4>
			<select id="people" style="min-width: 10vw">
				<option value="ALL">ALL</option>
				<!-- Always at top -->
			</select>

			<button
				id="downloadBtn"
				class="btn btn-primary"
				style="margin-left: 2vh"
			>
				Download
			</button>
		</main>

		<!-- Footer (shared across pages)-->
		<footer
			class="text-center text-muted small py-3 bg-body-tertiary border-top"
		>
			<div class="container">
				© 2025 Dakota State University · Built by CSC470 Software
				Engineering Team under Professor Jared Soundy
			</div>
		</footer>
		<!-- Bootstrap JS -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<!--scripting for just this page-->
		<script>
			const runSolverBtn = document.getElementById("runSolverBtn");
			const solverStatus = document.getElementById("solverStatus");

			async function runSolver() {
				solverStatus.className = "mt-3 small text-muted";
				solverStatus.textContent =
					"Running solver... it'll be a sec...";
				runSolverBtn.disabled = true;

				try {
					const response = await fetch("/api/admin/solve", {
						method: "POST",
					});

					const data = await response.json().catch(() => ({}));

					if (!response.ok || data.success === false) {
						const msg =
							data.message ||
							`Server returned status ${response.status}`;
						throw new Error(msg);
					}

					solverStatus.className = "mt-3 small text-success";
					solverStatus.textContent =
						data.message ||
						"Solver finished successfuly and Excel file was generated.";
				} catch (err) {
					console.error("Error running solver:", err);
					solverStatus.className = "mt-3 small text-danger";
					solverStatus.textContent =
						"Error running solver: " +
						(err.message || "Unknown error");
				} finally {
					runSolverBtn.disabled = false;
				}
			}

			runSolverBtn.addEventListener("click", (e) => {
				e.preventDefault();
				runSolver();
			});
		</script>
		<script>
			const select = document.getElementById("people");
			const downloadBtn = document.getElementById("downloadBtn");

			// Load names from backend
			fetch("/getNames")
				.then((res) => res.json())
				.then((names) => {
					names.forEach((name) => {
						const option = document.createElement("option");
						option.value = name;
						option.textContent = name;
						select.appendChild(option);
					});
				})
				.catch((err) => console.error("Error loading names:", err));

			// Download logic for any selected value
			downloadBtn.addEventListener("click", () => {
				const selected = select.value;

				if (!selected) {
					alert("Please select a name.");
					return;
				}

				// Fetch the file data from backend
				fetch("/downloadFile", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ name: selected }), // pass name or "ALL"
				})
					.then((res) => {
						if (!res.ok) throw new Error("Download failed");
						return res.blob(); // get the exact file returned
					})
					.then((blob) => {
						const url = window.URL.createObjectURL(blob);
						const link = document.createElement("a");
						link.href = url;

						// Keep a reasonable filename
						const filename = `${selected.replace(/\s+/g, "_")}.csv`;
						link.download = filename;

						document.body.appendChild(link);
						link.click();
						link.remove();
					})
					.catch((err) =>
						alert("Error downloading file: " + err.message)
					);
			});
		</script>
	</body>
</html>
